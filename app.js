// Global state for the chat
let conversationHistory = [];
let currentPhase = 'Fase 0';
let userProfile = {}; // Stores collected user preferences/interests
let suggestedAreas = []; // To store areas suggested in Fase 4.2
let selectedArea = ''; // To store the area selected by the user
let expectingConfirmation = false; // New state to manage confirmation buttons

// Constants for emojis
const EMOJI_WELCOME = 'üëã';
const EMOJI_GUIDE_QUESTION = 'üß≠';
const EMOJI_IDEA_SUGGESTION = 'üí°';
const EMOJI_ACADEMIC_INFO = 'üéì';
const EMOJI_SUMMARY_CONFIRMATION = '‚úÖ';
const EMOJI_REFLECTION = 'ü§î';
const EMOJI_PROFESSIONAL_CLARIFICATION = '‚öñÔ∏è';
const EMOJI_RESET = 'üîÑ';

// UI Elements
const splashScreen = document.getElementById('splash-screen');
const chatContent = document.getElementById('chat-content');
const chatMessagesDiv = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const loadingIndicator = document.getElementById('loading-indicator');
const confirmationButtonsDiv = document.getElementById('confirmation-buttons');
const yesButton = document.getElementById('yes-button');
const noButton = document.getElementById('no-button');
const textInputContainer = document.getElementById('text-input-container');


// Function to display messages in the chat interface
const displayMessage = (message, sender) => {
    const messageBubble = document.createElement('div');
    messageBubble.classList.add('message-bubble');
    if (sender === 'user') {
        messageBubble.classList.add('user-message');
    } else {
        messageBubble.classList.add('bot-message');
    }

    // Simple Markdown parsing for bold text (**)
    // This replaces **text** with <strong>text</strong>
    let parsedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Parse unordered list items (- Item)
    // This regex also handles nested unordered lists (e.g., "  - Sub-item")
    parsedMessage = parsedMessage.replace(/^( *)[*-] (.*)$/gm, (match, spaces, content) => {
        const indentLevel = spaces.length / 2; // Assuming 2 spaces per indent level
        return `<li style="margin-left: ${indentLevel * 1.5}rem;">${content}</li>`;
    });

    // Wrap top-level <li> elements in <ul> if they exist and are not already wrapped
    if (parsedMessage.includes('<li>') && !parsedMessage.includes('<ul>') && !parsedMessage.includes('<ol>')) {
        parsedMessage = `<ul>${parsedMessage}</ul>`;
    }

    // Parse ordered list items (1. Item)
    // This regex captures lines starting with a number followed by a dot and a space
    let orderedListHtml = '';
    const orderedListItems = parsedMessage.match(/^\d+\. (.*)$/gm);
    if (orderedListItems) {
        orderedListHtml = '<ol>';
        orderedListItems.forEach(item => {
            orderedListHtml += `<li>${item.replace(/^\d+\. /, '')}</li>`;
        });
        orderedListHtml += '</ol>';
        // Replace the original markdown list with the HTML list
        parsedMessage = parsedMessage.replace(/^\d+\. (.*)$/gm, '').trim(); // Remove original markdown list lines
        parsedMessage += orderedListHtml; // Append the new HTML ordered list
    }

    // Parse Markdown links [text](url)
    parsedMessage = parsedMessage.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:underline">$1</a>');


    messageBubble.innerHTML = parsedMessage; // Use innerHTML to render parsed Markdown
    chatMessagesDiv.appendChild(messageBubble);
    scrollToBottom();
};

// Function to scroll chat to the bottom
const scrollToBottom = () => {
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
};

// Function to show/hide confirmation buttons
const showConfirmationButtons = (show) => {
    if (show) {
        confirmationButtonsDiv.style.display = 'flex';
        textInputContainer.style.display = 'none'; // Hide regular input
        expectingConfirmation = true;
    } else {
        confirmationButtonsDiv.style.display = 'none';
        textInputContainer.style.display = 'flex'; // Show regular input
        expectingConfirmation = false;
    }
};

// Function to reset the conversation
const resetConversation = async () => {
    conversationHistory = [];
    currentPhase = 'Fase 0';
    userProfile = {};
    suggestedAreas = [];
    selectedArea = '';
    chatMessagesDiv.innerHTML = '';
    displayMessage(`${EMOJI_RESET} Reiniciando la conversaci√≥n...`, 'bot');
    showConfirmationButtons(false); // Hide buttons on reset
    setTimeout(() => getBotResponse(''), 1000); // Start new conversation
};

// Function to send message
const sendMessage = async (buttonMessage = null) => {
    let message = buttonMessage || userInput.value.trim();
    if (message === '') return;

    displayMessage(message, 'user');
    conversationHistory.push({ text: message, sender: 'user' });
    userInput.value = '';
    sendButton.disabled = true; // Disable button while processing
    loadingIndicator.classList.add('active'); // Show loading indicator
    showConfirmationButtons(false); // Hide buttons after any message is sent

    // Check for reset command
    if (message.toLowerCase() === 'empezar de nuevo' || message.toLowerCase() === 'reset') {
        await resetConversation();
        sendButton.disabled = false;
        loadingIndicator.classList.remove('active');
        return;
    }

    await getBotResponse(message);
    sendButton.disabled = false;
    loadingIndicator.classList.remove('active');
};

// Function to get bot response from Gemini API (now via Vercel Serverless Function)
const getBotResponse = async (userMessage) => {
    let prompt = `
    Eres **Explora tu vocaci√≥n con IA - Expo carreras 2026**, un asistente vocacional, dise√±ado para guiar a estudiantes de 5¬∫ y 6¬∫ a√±o de la secundaria en la provincia de La Pampa, Argentina. Tu misi√≥n es facilitar un proceso de autodescubrimiento y reflexi√≥n que conecte la identidad personal del estudiante con la exploraci√≥n de la oferta acad√©mica superior de manera accesible, clara y profesional. Eres una herramienta de apoyo para el primer paso de la orientaci√≥n, no un reemplazo de un orientador humano.

    Tu personalidad es la de un gu√≠a paciente, alentador, curioso y objetivo. La interacci√≥n debe sentirse como una conversaci√≥n estructurada pero natural, que genera confianza y seguridad.

    **Identidad Visual en el Texto:**
    Uso de Markdown: Emplea Markdown para jerarquizar y clarificar la informaci√≥n.
    Negrita: Usa negrita para resaltar conceptos clave, nombres de carreras o √°reas de conocimiento.
    **Todas las preguntas que hagas, incluyendo las iniciales, deben estar en negrita.**
    Listas con Vi√±etas: Utiliza listas (con * o -) para presentar opciones, res√∫menes y recomendaciones.
    Paleta de Emojis: Utiliza los siguientes emojis de forma sutil y consistente:
    üëã Bienvenida y Despedida
    üß≠ Gu√≠a y Preguntas
    üí° Ideas y Sugerencias
    üéì Informaci√≥n Acad√©mica
    ‚úÖ Res√∫menes y Confirmaciones
    ü§î Reflexi√≥n
    ‚öñÔ∏è Aclaraci√≥n Profesional
    üîÑ Reinicio

    **Claridad y Accesibilidad:**
    Lenguaje Sencillo: Evita la jerga acad√©mica. Si usas un t√©rmino como "tecnicatura" o "carrera de grado", explica brevemente la diferencia.
    Voseo Argentino: Utiliza siempre el "vos" de manera natural.
    Paciencia: Si una respuesta del usuario es ambigua ("no s√©", "quiz√°s"), responde con empat√≠a y reformula la pregunta desde otro √°ngulo.
    **Si en alg√∫n momento me pregunt√°s mi nombre, por favor, aclar√° que solo quer√©s el nombre, sin el apellido.**

    **Base de Conocimiento y Prioridades:**
    Tu conocimiento sobre oferta acad√©mica debe seguir este orden estricto:
    1.  **Prioridad 1 (La Pampa):** Oferta de la UNLPam, Institutos Superiores (ISFD, etc.), p√∫blicos y privados, en La Pampa. Cubre tecnicaturas, carreras de grado y profesorados en todas sus modalidades.
        **Cuando te refieras al Instituto Tecnol√≥gico de Educaci√≥n Superior de La Pampa, utiliza siempre el acr√≥nimo ITES.**
    2.  **Prioridad 2 (Nacional Online):** Carreras a distancia de universidades nacionales reconocidas (ej. UBA XXI, UNQ Virtual, UNL Virtual).
    3.  **Prioridad 3 (Otras Provincias):** Carreras presenciales en otras provincias, solo si el estudiante expresa expl√≠citamente su disposici√≥n a mudarse.

    **Flujo de Conversaci√≥n y L√≥gica de Interacci√≥n:**
    Tu directriz principal es un di√°logo paso a paso. Nunca hagas m√°s de una pregunta a la vez.
    **El bot puede permitir saltar preguntas o profundizar seg√∫n el inter√©s del usuario.**
    **Es deseable que el bot no etiquete prematuramente al estudiante (evitar "sos m√°s humanista" o "sos t√©cnico"), sino que devuelva insumos reflexivos.**

    **Contexto de la conversaci√≥n actual:**
    Fase actual: ${currentPhase}
    Perfil del estudiante (hasta ahora): ${JSON.stringify(userProfile, null, 2)}
    √Åreas sugeridas (si aplica): ${JSON.stringify(suggestedAreas)}
    √Årea seleccionada (si aplica): ${selectedArea}
    Mensaje del usuario: "${userMessage}"

    **Instrucciones para la pr√≥xima respuesta (basadas en la fase actual y el mensaje del usuario):**
    **Importante: Evita repetir la informaci√≥n que el estudiante acaba de mencionar, a menos que sea para un resumen expl√≠cito de confirmaci√≥n (Fase 3.1). S√© lo m√°s sint√©tico posible en tus respuestas.**

    `;

    // Append specific instructions based on the current phase
    switch (currentPhase) {
        case 'Fase 0':
            prompt += `
            **Paso 0.1:** ${EMOJI_WELCOME} Hola, soy **Explora tu vocaci√≥n, tu asistente virtual en la Expo Carreras 2026**.
            Importante: Este asistente fue dise√±ado con Inteligencia Artificial (IA) para acompa√±arte en la exploraci√≥n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaci√≥n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexi√≥n, di√°logo y consulta humana.
            **Pregunta:** **¬øQu√© actividades te entusiasman o te hacen perder la noci√≥n del tiempo cuando las hac√©s?**
            `;
            break;
        case 'Fase 1.1': // This phase now handles the response to the initial question
            // User just responded to the initial welcome+question, now transition to the next logical step.
            // No new question is asked by the bot in this prompt, as the previous phase already asked the first question.
            // The updatePhase function will handle the transition to Fase 1.2
            prompt += `
            El usuario acaba de responder a la pregunta inicial: "${userMessage}".
            Analiza su respuesta.
            Si la respuesta es muy breve, general, o parece que el usuario necesita m√°s ideas (ej. 'no s√©', 'muchas cosas', 'lo normal'), entonces **brinda los ejemplos detallados**: "Por ejemplo, editar videos, reparar cosas, ayudar a otros, escribir historias, programar juegos, cuidar plantas, dise√±ar ropa, investigar temas de ciencia, practicar deportes, organizar eventos o aprender idiomas, entre muchas otras." Y luego, **reformula la pregunta inicial de forma alentadora** para que el usuario pueda expandirse.
            Si la respuesta es clara y espec√≠fica, entonces **contin√∫a el di√°logo en forma natural** y pasa a la siguiente pregunta de la secuencia (Paso 1.2).
            `;
            userProfile.actividades_ocio = userMessage; // Store response from previous phase
            break;
        case 'Fase 1.2':
            prompt += `
            **Paso 1.2:** ${EMOJI_GUIDE_QUESTION} **¬øQu√© materias o temas del colegio disfrut√°s m√°s y por qu√©? ¬øY alguna que te guste menos? Contame un poco por qu√©.**
            `;
            userProfile.materias_gusto = userMessage;
            break;
        case 'Fase 1.3':
            prompt += `
            **Paso 1.3:** ${EMOJI_GUIDE_QUESTION} **Si pudieras elegir un proyecto o causa en la que trabajar durante un a√±o, ¬øcu√°l ser√≠a y qu√© rol te gustar√≠a tener?**
            `;
            userProfile.proyecto_causa = userMessage;
            break;
        case 'Fase 1.4':
            prompt += `
            **Paso 1.4:** ${EMOJI_GUIDE_QUESTION} **¬øPrefer√≠s trabajar en contacto con personas, con ideas, con tecnolog√≠as, con la naturaleza o con objetos f√≠sicos?**
            `;
            userProfile.preferencia_contacto = userMessage;
            break;
        case 'Fase 2.1':
            prompt += `
            **Paso 2.1:** ${EMOJI_GUIDE_QUESTION} **¬øTe imagin√°s trabajando en un mismo lugar todos los d√≠as o prefer√≠s cambiar de espacios, moverte, viajar?**
            `;
            userProfile.estilo_lugar_trabajo = userMessage;
            break;
        case 'Fase 2.2':
            prompt += `
            **Paso 2.2:** ${EMOJI_GUIDE_QUESTION} **¬øQu√© te gustar√≠a que las personas valoren de tu trabajo en el futuro?**
            `;
            userProfile.valores_trabajo = userMessage;
            break;
        case 'Fase 2.3':
            prompt += `
            **Paso 2.3:** ${EMOJI_GUIDE_QUESTION} **¬øYa conoc√©s algunas carreras, tecnicaturas u oficios que te llamen la atenci√≥n? ¬øQuer√©s que te comparta informaci√≥n sobre ellas o sobre c√≥mo seguir explorando?**
            `;
            userProfile.carreras_preexistentes = userMessage;
            break;
        case 'Fase 3.1': // This phase is now the "Resumen General"
            prompt += `
            **Paso 3.1:** ${EMOJI_SUMMARY_CONFIRMATION} Resumen General. Pide validaci√≥n final del perfil completo.
            Genera un resumen conciso del perfil del estudiante, incluyendo sus actividades de ocio, materias favoritas/menos favoritas, proyecto/causa ideal, preferencia de contacto en el trabajo, estilo de lugar de trabajo y valores en el trabajo.
            **Pregunta:** **¬øEs correcto este resumen de tu perfil?**
            **A√±ade al final de tu respuesta el marcador oculto: ---CONFIRMAR_SI_NO---**
            `;
            userProfile.confirmacion_perfil = userMessage; // Store confirmation
            break;
        case 'Fase 3.2': // This phase now handles the logistical filter, after profile confirmation
            prompt += `
            **Paso 3.2:** ${EMOJI_GUIDE_QUESTION} Para afinar las opciones, **¬øprefer√≠s quedarte en La Pampa, te interesa estudiar a distancia (online), o estar√≠as dispuesto/a a mudarte a otra provincia?**
            `;
            userProfile.preferencias_logisticas = userMessage; // Store logistical preference
            break;
        case 'Fase 4.1': // This phase suggests areas based on the profile and logistical preference
            prompt += `
            **Paso 4.1:** ${EMOJI_IDEA_SUGGESTION} Sugiere de 2 a 3 √Åreas de Conocimiento y pregunta cu√°l explorar.
            Basado en el perfil completo del estudiante y su preferencia log√≠stica (${userProfile.preferencias_logisticas}), sugiere 2 o 3 √°reas de conocimiento generales (ej. Ciencias de la Salud, Tecnolog√≠a, Artes y Dise√±o, Ciencias Sociales, Educaci√≥n, Ciencias Agrarias).
            **Aseg√∫rate de que estas √°reas est√©n formateadas como una lista con vi√±etas (ej. * √Årea 1).**
            **Pregunta al estudiante cu√°l de esas √°reas le gustar√≠a explorar primero.**
            **IMPORTANTE:** Guarda las √°reas sugeridas en la variable 'suggestedAreas' para referencia futura.
            `;
            userProfile.preferencias_logisticas = userMessage; // Store logistical preference
            break;
        case 'Fase 4.2': // This phase is triggered when user selects an area
            prompt += `
            **Paso 4.2:** ${EMOJI_ACADEMIC_INFO} Proporciona un listado de carreras espec√≠ficas del √°rea elegida.
            El usuario ha elegido el √°rea: "${userMessage}".
            Ahora, lista de 3 a 5 carreras espec√≠ficas dentro de esa √°rea, siguiendo el orden de prioridad de conocimiento (La Pampa > Nacional Online > Otras Provincias si aplica).
            Para cada carrera, menciona brevemente si es una **tecnicatura**, **carrera de grado** o **profesorado**, y si es **presencial** u **online**.
            **Aseg√∫rate de que la respuesta est√© estructurada con vi√±etas para cada instituci√≥n, y vi√±etas anidadas para las carreras debajo de cada instituci√≥n, incluyendo un enlace al sitio oficial si es posible. Ejemplo:**
            **Ejemplo de formato:**
            * Universidad Nacional de La Pampa (UNLPam):
                * Ingenier√≠a en Sistemas: (descripci√≥n breve) [Enlace al sitio oficial]
                * Profesorado en Computaci√≥n: (descripci√≥n breve) [Enlace al sitio oficial]
            * Instituto Tecnol√≥gico de Educaci√≥n Superior de La Pampa (ITES):
                * Tecnicatura Superior en Desarrollo de Software: (descripci√≥n breve) [Enlace al sitio oficial]
                * Tecnicatura Superior en Redes Inform√°ticas: (descripci√≥n breve) [Enlace al sitio oficial]
            **Si el usuario no eligi√≥ una de las √°reas sugeridas, p√≠dele que elija una de las opciones o que aclare su inter√©s.**
            `;
            selectedArea = userMessage; // Store the selected area
            break;
        case 'Fase 4.3': // This phase is now the reflection on options
            prompt += `
            **Paso 4.3:** ${EMOJI_REFLECTION} Plantea una pregunta abierta para fomentar la reflexi√≥n sobre las opciones.
            Ejemplo: "De estas carreras que te mencion√©, ¬øhay alguna que te genere m√°s curiosidad o que te llame la atenci√≥n? ¬øPor qu√©?"
            **Aseg√∫rate de que esta pregunta est√© en negrita.**
            `;
            userProfile.carreras_sugeridas_area = userMessage; // Store the list of careers suggested by the bot
            break;
        case 'Fase 4.4': // This phase is now offering to deepen
            prompt += `
            **Paso 4.4:** Ofrece profundizar en la carrera que m√°s le interes√≥ (materias, duraci√≥n, etc.).
            El usuario ha expresado inter√©s en: "${userMessage}".
            **Pregunta si quiere que profundices en esa carrera (ej. materias principales, duraci√≥n aproximada, perfil del egresado, d√≥nde se estudia).**
            `;
            userProfile.carrera_interes_fase4 = userMessage;
            break;
        case 'Fase 5.1': // This phase is now asking to explore more or close
            prompt += `
            **Paso 5.1:** Pregunta si quiere explorar otra de las √°reas sugeridas o si tiene alguna otra duda.
            Recuerda las √°reas sugeridas previamente: ${JSON.stringify(suggestedAreas)}.
            **Aseg√∫rate de que esta pregunta est√© en negrita.**
            `;
            userProfile.profundizacion_carrera = userMessage;
            break;
        case 'Fase 5.2': // This phase is now the final summary and next steps
            prompt += `
            **Paso 5.2:** Para cerrar, ofrece un resumen de las conclusiones y sugiere los pr√≥ximos pasos pr√°cticos (visitar sitios web, buscar testimonios, etc.).
            Importante: Este asistente fue dise√±ado con Inteligencia Artificial para acompa√±arte en la exploraci√≥n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaci√≥n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexi√≥n, di√°logo y consulta humana.
            Si el usuario quiere explorar otra √°rea, vuelve a la Fase 4.2 (anteriormente 4.3) con la nueva √°rea. Si tiene otra duda, responde la duda. Si quiere cerrar, procede con el resumen y los pr√≥ximos pasos.
            `;
            userProfile.exploracion_adicional = userMessage;
            break;
        case 'Fase 5.3': // This phase is now the disclaimer
            prompt += `
            **Paso 5.3:** ${EMOJI_PROFESSIONAL_CLARIFICATION} Aclaraci√≥n Final Importante.
            Incluye siempre la siguiente aclaraci√≥n, presentada de forma destacada:
            "**Aclaraci√≥n Importante:** Record√° que soy una herramienta de inteligencia artificial dise√±ada para darte ideas y servir como un primer paso en tu exploraci√≥n. Este di√°logo es un excelente punto de partida, pero no sustituye el valioso criterio, la escucha y el acompa√±amiento personalizado de un profesional de la orientaci√≥n vocacional. Te animo a conversar sobre estas ideas con un psic√≥logo/a o psicopedagogo/a de tu confianza para tomar la decisi√≥n final m√°s informada."
            Luego, procede al Paso 5.4.
            `;
            userProfile.cierre_confirmado = userMessage;
            break;
        case 'Fase 5.4': // This phase is now the reset option
            prompt += `
            **Paso 5.4:** ${EMOJI_RESET} Ofrece la opci√≥n de reseteo. Presenta la instrucci√≥n de forma clara, como un enlace de texto.
            Texto: "Si en alg√∫n momento quer√©s volver a explorar todo desde cero con otras ideas, pod√©s hacerlo. Para eso, simplemente escrib√≠ la frase **empezar de nuevo**."
            Luego, procede al Paso 5.5.
            `;
            break;
        case 'Fase 5.5': // This phase is now the farewell
            prompt += `
            **Paso 5.5:** Ahora s√≠, desp√≠dete con un mensaje alentador y el emoji ${EMOJI_WELCOME}.
            Ejemplo: "¬°Fue un gusto conversar con vos! Te deseo mucho √©xito en tu b√∫squeda y en el camino que elijas. ¬°Hasta la pr√≥xima! üëã"
            `;
            break;
        case 'Fase 5.6':
            // End of conversation, or user might restart
            // No phase change, waiting for reset command
            break;
        default:
            console.warn("Unhandled phase transition:", current);
            break;
    }

    // Add previous conversation history to the prompt for context
    let chatHistory = [];
    conversationHistory.forEach(msg => {
        chatHistory.push({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
    });
    // Agrega el prompt final como el √∫ltimo mensaje del usuario para el modelo
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    try {
        // La URL ahora apunta a tu propia funci√≥n serverless en Vercel
        const apiUrl = '/api/gemini'; // Ruta relativa a tu aplicaci√≥n en Vercel

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // Env√≠a el historial de chat completo a la funci√≥n serverless
            body: JSON.stringify({ chatHistory: chatHistory })
        });

        const result = await response.json();

        // Si la funci√≥n serverless devuelve un error (ej. por clave API no encontrada)
        if (response.status !== 200) {
            console.error("Error de la funci√≥n serverless:", result.error);
            displayMessage("Disculp√°, hubo un problema en el servidor. Por favor, intent√° de nuevo m√°s tarde o verific√° la configuraci√≥n de la API Key en Vercel.", 'bot');
            return; // Salir para no procesar como respuesta exitosa
        }

        // Si la respuesta es exitosa, el texto viene en result.text
        if (result.text) {
            let botResponse = result.text;

            // Check for the hidden marker to show confirmation buttons
            if (botResponse.includes('---CONFIRMAR_SI_NO---')) {
                botResponse = botResponse.replace('---CONFIRMAR_SI_NO---', '').trim(); // Remove marker
                setTimeout(() => showConfirmationButtons(true), 300); // Show buttons with a slight delay
            } else {
                showConfirmationButtons(false); // Ensure buttons are hidden if not a confirmation
            }

            displayMessage(botResponse, 'bot');
            conversationHistory.push({ text: botResponse, sender: 'bot' });

            // Update phase based on currentPhase and expected user input
            updatePhase(currentPhase, userMessage, botResponse);

        } else {
            console.error("Estructura de respuesta inesperada de la funci√≥n serverless:", result);
            displayMessage("Disculp√°, no pude generar una respuesta. Hubo un problema con la respuesta del modelo.", 'bot');
        }
    } catch (error) {
        console.error("Error al llamar a la funci√≥n serverless:", error);
        // Mensaje de error m√°s espec√≠fico para problemas de red o de la funci√≥n serverless
        displayMessage("Disculp√°, no pude generar una respuesta. Parece haber un problema de conexi√≥n o con el servidor. Por favor, intent√° de nuevo.", 'bot');
    }
};

// Function to update the conversation phase
const updatePhase = (current, userMsg, botResponse) => {
    switch (current) {
        case 'Fase 0': // After Q1 (actividades ocio)
            currentPhase = 'Fase 1.1'; // Now, Fase 1.1 will process the response and potentially ask Q2 (materias)
            break;
        case 'Fase 1.1': // After Q1 (actividades ocio) and bot's conditional response
            // If bot provided examples, user's next response is still for Q1.
            // If bot moved on, user's response is for Q2.
            // The LLM's response in Fase 1.1 will dictate the next state.
            // We need to check if the bot's response in Fase 1.1 contained examples or moved to Q1.2
            if (botResponse.includes('Por ejemplo, editar videos')) { // Simple check for example text
                currentPhase = 'Fase 1.1'; // Stay in Fase 1.1 if examples were given, waiting for better response to Q1
            } else {
                currentPhase = 'Fase 1.2'; // Move to Fase 1.2 (Q2) if bot moved on
            }
            break;
        case 'Fase 1.2': // After Q2 (materias)
            currentPhase = 'Fase 1.3'; // Next is Q3 (proyecto/causa)
            break;
        case 'Fase 1.3': // After Q3 (proyecto/causa)
            currentPhase = 'Fase 1.4'; // Next is Q4 (preferencia contacto)
            break;
        case 'Fase 1.4': // After Q4 (preferencia contacto)
            currentPhase = 'Fase 2.1'; // Next is Q5 (estilo lugar trabajo)
            break;
        case 'Fase 2.1': // After Q5 (estilo lugar trabajo)
            currentPhase = 'Fase 2.2'; // Next is Q6 (valores trabajo)
            break;
        case 'Fase 2.2': // After Q6 (valores trabajo)
            currentPhase = 'Fase 2.3'; // Next is Q7 (carreras preexistentes)
            break;
        case 'Fase 2.3': // After Q7 (carreras preexistentes)
            currentPhase = 'Fase 3.1'; // Next is Logistical filter (Pampa, online, mudarse)
            break;
        case 'Fase 3.1': // After Logistical filter (Pampa, online, mudarse)
            // If user confirms summary, move to 4.1 (suggest areas), else stay in 3.1 for clarification
            if (userMsg.toLowerCase().includes('s√≠') || userMsg.toLowerCase().includes('correcto') || userMsg.toLowerCase().includes('si')) {
                currentPhase = 'Fase 4.1'; // Transition to suggest areas
            } else {
                currentPhase = 'Fase 3.1'; // Re-ask for clarification
            }
            break;
        case 'Fase 3.2': // This phase is now the overall profile summary and confirmation
            currentPhase = 'Fase 3.1'; // Loop back to summary if not confirmed, or proceed to 4.1 if confirmed
            break; // This case should not be hit if 3.1 handles the confirmation logic.
        case 'Fase 4.1': // After profile summary confirmation, suggests areas
            currentPhase = 'Fase 4.2'; // Next is list specific careers
            break;
        case 'Fase 4.2': // After selecting an area, lists specific careers
            currentPhase = 'Fase 4.3'; // Next is reflection on options
            break;
        case 'Fase 4.3': // After reflection, offers to deepen
            currentPhase = 'Fase 4.4'; // Next is offering to deepen
            break;
        case 'Fase 4.4': // After offering to deepen
            currentPhase = 'Fase 5.1'; // Next is asking to explore more or close
            break;
        case 'Fase 5.1': // After asking to explore more or close
            currentPhase = 'Fase 5.2'; // Next is final summary and next steps
            break;
        case 'Fase 5.2': // After final summary and next steps
            currentPhase = 'Fase 5.3'; // Next is disclaimer
            break;
        case 'Fase 5.3': // After disclaimer
            currentPhase = 'Fase 5.4'; // Next is reset option
            break;
        case 'Fase 5.4': // After reset option
            currentPhase = 'Fase 5.5'; // Next is farewell
            break;
        case 'Fase 5.5': // Farewell
            currentPhase = 'Fase 5.6'; // End state, waiting for reset command
            break;
        case 'Fase 5.6':
            // End of conversation, or user might restart
            // No phase change, waiting for reset command
            break;
        default:
            console.warn("Unhandled phase transition:", current);
            break;
    }
};

// Event Listeners
sendButton.addEventListener('click', () => sendMessage());
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
yesButton.addEventListener('click', () => sendMessage('S√≠'));
noButton.addEventListener('click', () => sendMessage('No'));


// Initial setup on window load
window.onload = () => {
    // Hide splash screen and show chat content after a short delay
    setTimeout(() => {
        splashScreen.classList.add('hidden');
        chatContent.classList.add('visible');
        setTimeout(() => getBotResponse(''), 500); // Trigger welcome message after splash fades
    }, 4000); // Display splash screen for 4 seconds
};
